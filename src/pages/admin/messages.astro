---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { supabase } from '../../lib/supabase';

// Check authentication
const { data: { session } } = await supabase.auth.getSession();
if (!session) {
  return Astro.redirect('/admin/login');
}

// Fetch messages
const { data: messages } = await supabase
  .from('contact_submissions')
  .select('*')
  .order('created_at', { ascending: false });
---

<AdminLayout title="Mensajes">
  <div class="admin-header">
    <div>
      <h1 class="admin-title">Mensajes de Contacto</h1>
      <p class="admin-subtitle">Gestiona los mensajes recibidos del formulario</p>
    </div>
  </div>

  <div class="admin-section">
    <div class="table-container">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Email</th>
            <th>Mensaje</th>
            <th>Estado</th>
            <th>Fecha</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {messages && messages.length > 0 ? (
            messages.map((msg) => (
              <tr>
                <td>
                  <div class="table-title">{msg.name}</div>
                  {msg.phone && <div class="table-phone">{msg.phone}</div>}
                </td>
                <td>
                  <a href={`mailto:${msg.email}`} class="table-email">{msg.email}</a>
                </td>
                <td>
                  <div class="table-message">{msg.message.substring(0, 100)}{msg.message.length > 100 ? '...' : ''}</div>
                </td>
                <td>
                  <span class={`status-badge status-${msg.status || 'new'}`}>
                    {msg.status === 'read' ? 'Leído' : msg.status === 'replied' ? 'Respondido' : 'Nuevo'}
                  </span>
                </td>
                <td>
                  <div class="table-date">
                    {new Date(msg.created_at).toLocaleDateString('es-ES', {
                      year: 'numeric',
                      month: 'short',
                      day: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit'
                    })}
                  </div>
                </td>
                <td>
                  <div class="table-actions">
                    <button class="action-btn mark-read-btn" data-id={msg.id} title="Marcar como leído">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M13.3333 4L6 11.3333L2.66667 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                    <button class="action-btn action-btn-danger delete-msg-btn" data-id={msg.id} title="Eliminar">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M2 4H14M12.6667 4V13.3333C12.6667 14 12 14.6667 11.3333 14.6667H4.66667C4 14.6667 3.33333 14 3.33333 13.3333V4M5.33333 4V2.66667C5.33333 2 6 1.33333 6.66667 1.33333H9.33333C10 1.33333 10.6667 2 10.6667 2.66667V4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  </div>
                </td>
              </tr>
            ))
          ) : (
            <tr>
              <td colspan="6" class="table-empty">
                No hay mensajes todavía.
              </td>
            </tr>
          )}
        </tbody>
      </table>
    </div>
  </div>
</AdminLayout>

<script>
  import { supabase } from '../../lib/supabase';

  // Mark as read
  document.querySelectorAll('.mark-read-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const id = (e.currentTarget as HTMLButtonElement).dataset.id;
      
      try {
        const { error } = await supabase
          .from('contact_submissions')
          .update({ status: 'read' })
          .eq('id', id);

        if (error) throw error;
        window.location.reload();
      } catch (error) {
        alert('Error al actualizar el mensaje');
      }
    });
  });

  // Delete message
  document.querySelectorAll('.delete-msg-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const id = (e.currentTarget as HTMLButtonElement).dataset.id;
      
      if (confirm('¿Eliminar este mensaje?')) {
        try {
          const { error } = await supabase
            .from('contact_submissions')
            .delete()
            .eq('id', id);

          if (error) throw error;
          window.location.reload();
        } catch (error) {
          alert('Error al eliminar el mensaje');
        }
      }
    });
  });
</script>

<style>
  .admin-header {
    margin-bottom: var(--space-2xl);
  }

  .admin-title {
    font-size: var(--text-4xl);
    font-weight: 800;
    color: var(--color-dark);
    margin-bottom: var(--space-xs);
  }

  .admin-subtitle {
    color: var(--color-gray);
    font-size: var(--text-lg);
  }

  .admin-section {
    background: var(--color-white);
    border-radius: var(--radius-xl);
    padding: var(--space-xl);
    box-shadow: var(--shadow-md);
  }

  .table-container {
    overflow-x: auto;
  }

  .admin-table {
    width: 100%;
    border-collapse: collapse;
  }

  .admin-table th {
    text-align: left;
    padding: var(--space-sm) var(--space-md);
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-gray);
    border-bottom: 2px solid var(--color-gray-light);
  }

  .admin-table td {
    padding: var(--space-md);
    border-bottom: 1px solid var(--color-gray-light);
  }

  .table-title {
    font-weight: 600;
    color: var(--color-dark);
  }

  .table-phone {
    font-size: var(--text-sm);
    color: var(--color-gray);
  }

  .table-email {
    color: var(--color-primary);
    text-decoration: none;
  }

  .table-email:hover {
    text-decoration: underline;
  }

  .table-message {
    max-width: 300px;
    color: var(--color-gray);
    font-size: var(--text-sm);
  }

  .table-date {
    color: var(--color-gray);
    font-size: var(--text-sm);
    white-space: nowrap;
  }

  .table-empty {
    text-align: center;
    padding: var(--space-2xl) !important;
    color: var(--color-gray);
  }

  .status-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: 600;
  }

  .status-new {
    background: rgba(0, 102, 204, 0.1);
    color: var(--color-primary);
  }

  .status-read {
    background: rgba(108, 117, 125, 0.1);
    color: var(--color-gray);
  }

  .status-replied {
    background: rgba(6, 214, 160, 0.1);
    color: var(--color-success);
  }

  .table-actions {
    display: flex;
    gap: var(--space-xs);
  }

  .action-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-md);
    color: var(--color-gray);
    transition: all var(--transition-base);
    border: none;
    background: none;
    cursor: pointer;
  }

  .action-btn:hover {
    background: var(--color-gray-light);
    color: var(--color-primary);
  }

  .action-btn-danger:hover {
    background: rgba(255, 107, 53, 0.1);
    color: var(--color-accent);
  }
</style>
