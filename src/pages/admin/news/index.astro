---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { supabase } from '../../../lib/supabase';

// Check authentication
const { data: { session } } = await supabase.auth.getSession();
if (!session) {
  return Astro.redirect('/admin/login');
}

// Fetch all news
const { data: newsList } = await supabase
  .from('news')
  .select('*')
  .order('created_at', { ascending: false });
---

<AdminLayout title="Gestión de Noticias">
  <div class="admin-header">
    <div>
      <h1 class="admin-title">Noticias</h1>
      <p class="admin-subtitle">Gestiona las noticias y anuncios del club</p>
    </div>
    <a href="/admin/news/create" class="btn btn-primary">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
        <path d="M10 4V16M4 10H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      Nueva Noticia
    </a>
  </div>

  <div class="admin-section">
    <div class="table-container">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Título</th>
            <th>Estado</th>
            <th>Fecha</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {newsList && newsList.length > 0 ? (
            newsList.map((news) => (
              <tr>
                <td>
                  <div class="table-title">{news.title}</div>
                  <div class="table-excerpt">{news.excerpt}</div>
                </td>
                <td>
                  <span class={`status-badge ${news.published ? 'status-published' : 'status-draft'}`}>
                    {news.published ? 'Publicado' : 'Borrador'}
                  </span>
                </td>
                <td>
                  <div class="table-date">
                    {new Date(news.created_at).toLocaleDateString('es-ES', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric'
                    })}
                  </div>
                </td>
                <td>
                  <div class="table-actions">
                    <a href={`/admin/news/edit/${news.id}`} class="action-btn" title="Editar">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M11.333 2.00004C11.5081 1.82494 11.716 1.68605 11.9447 1.59129C12.1735 1.49653 12.4187 1.44775 12.6663 1.44775C12.914 1.44775 13.1592 1.49653 13.3879 1.59129C13.6167 1.68605 13.8246 1.82494 13.9997 2.00004C14.1748 2.17513 14.3137 2.383 14.4084 2.61178C14.5032 2.84055 14.552 3.08575 14.552 3.33337C14.552 3.58099 14.5032 3.82619 14.4084 4.05497C14.3137 4.28374 14.1748 4.49161 13.9997 4.66671L5.33301 13.3334L1.99967 14.3334L2.99967 11L11.333 2.00004Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </a>
                    <button class="action-btn action-btn-danger delete-btn" data-id={news.id} title="Eliminar">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M2 4H14M12.6667 4V13.3333C12.6667 14 12 14.6667 11.3333 14.6667H4.66667C4 14.6667 3.33333 14 3.33333 13.3333V4M5.33333 4V2.66667C5.33333 2 6 1.33333 6.66667 1.33333H9.33333C10 1.33333 10.6667 2 10.6667 2.66667V4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  </div>
                </td>
              </tr>
            ))
          ) : (
            <tr>
              <td colspan="4" class="table-empty">
                No hay noticias todavía. <a href="/admin/news/create">Crear la primera</a>
              </td>
            </tr>
          )}
        </tbody>
      </table>
    </div>
  </div>
</AdminLayout>

<script>
  import { supabase } from '../../../lib/supabase';

  // Delete functionality
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const id = (e.currentTarget as HTMLButtonElement).dataset.id;
      
      if (confirm('¿Estás seguro de que quieres eliminar esta noticia?')) {
        try {
          const { error } = await supabase
            .from('news')
            .delete()
            .eq('id', id);

          if (error) throw error;

          // Reload page
          window.location.reload();
        } catch (error) {
          alert('Error al eliminar la noticia');
          console.error(error);
        }
      }
    });
  });
</script>

<style>
  .admin-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-2xl);
    gap: var(--space-lg);
  }

  .admin-title {
    font-size: var(--text-4xl);
    font-weight: 800;
    color: var(--color-dark);
    margin-bottom: var(--space-xs);
  }

  .admin-subtitle {
    color: var(--color-gray);
    font-size: var(--text-lg);
  }

  .admin-section {
    background: var(--color-white);
    border-radius: var(--radius-xl);
    padding: var(--space-xl);
    box-shadow: var(--shadow-md);
  }

  .table-container {
    overflow-x: auto;
  }

  .admin-table {
    width: 100%;
    border-collapse: collapse;
  }

  .admin-table th {
    text-align: left;
    padding: var(--space-sm) var(--space-md);
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-gray);
    border-bottom: 2px solid var(--color-gray-light);
  }

  .admin-table td {
    padding: var(--space-md);
    border-bottom: 1px solid var(--color-gray-light);
  }

  .table-title {
    font-weight: 600;
    color: var(--color-dark);
    margin-bottom: 0.25rem;
  }

  .table-excerpt {
    font-size: var(--text-sm);
    color: var(--color-gray);
  }

  .table-date {
    color: var(--color-gray);
    font-size: var(--text-sm);
  }

  .table-empty {
    text-align: center;
    padding: var(--space-2xl) !important;
    color: var(--color-gray);
  }

  .table-empty a {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 600;
  }

  .status-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: 600;
  }

  .status-published {
    background: rgba(6, 214, 160, 0.1);
    color: var(--color-success);
  }

  .status-draft {
    background: rgba(108, 117, 125, 0.1);
    color: var(--color-gray);
  }

  .table-actions {
    display: flex;
    gap: var(--space-xs);
  }

  .action-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-md);
    color: var(--color-gray);
    transition: all var(--transition-base);
    text-decoration: none;
    border: none;
    background: none;
    cursor: pointer;
  }

  .action-btn:hover {
    background: var(--color-gray-light);
    color: var(--color-primary);
  }

  .action-btn-danger:hover {
    background: rgba(255, 107, 53, 0.1);
    color: var(--color-accent);
  }
</style>
